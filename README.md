```

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—      â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•šâ•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•        â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•


```

# ğŸš€ [RISCV-LAB](https://code.educoder.net/ppg69fuwb/riscv-lab)

ä»é›¶å¼€å§‹çš„ RV64IMAZicsr_Zifencei æµæ°´çº¿è®¾è®¡å®éªŒ

## ğŸ“š ç®€ä»‹

- æ”¯æŒ RV64IMAZicsr_Zifencei æŒ‡ä»¤é›†çš„é¡ºåºåŠ¨æ€åŒå‘å°„äº”çº§æµæ°´çº¿
- å¯æ¥å…¥å·®åˆ†æµ‹è¯•æ¡†æ¶ï¼Œæä¾›è½¯ä»¶ä»¿çœŸæµ‹è¯•
- é¢å‘æ•™å­¦çš„å®éªŒè®¾è®¡ï¼Œè¯·æ­é…å®éªŒæŒ‡å¯¼æ‰‹å†Œé£Ÿç”¨

## ğŸ¬ ç›®å½•ç»“æ„

```bash
.
â”œâ”€â”€ .git # ç”¨äºå­˜å‚¨Gitç‰ˆæœ¬åº“
â”œâ”€â”€ .gitignore # ç”¨äºé…ç½®Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ .vscode # ç”¨äºé…ç½®VSCodeç¼–è¾‘å™¨
â”œâ”€â”€ README.md # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ chisel # Chiselä»£ç 
â”‚ â”œâ”€â”€ .bloop # ç”¨äºé…ç½®Bloopç¼–è¯‘å™¨
â”‚ â”œâ”€â”€ .gitignore # ç”¨äºé…ç½®Gitå¿½ç•¥æ–‡ä»¶
â”‚ â”œâ”€â”€ .metals # ç”¨äºé…ç½®Metalsç¼–è¯‘å™¨
â”‚ â”œâ”€â”€ .scalafmt.conf # ç”¨äºé…ç½®Scalafmtä»£ç æ ¼å¼åŒ–å·¥å…·
â”‚ â”œâ”€â”€ .vscode # ç”¨äºé…ç½®VSCodeç¼–è¾‘å™¨
â”‚ â”œâ”€â”€ Makefile # ç”¨äºé…ç½®Makeç¼–è¯‘å·¥å…·
â”‚ â”œâ”€â”€ README.md # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”‚ â”œâ”€â”€ build # ç”¨äºå­˜å‚¨Chiselç”Ÿæˆçš„Verilogæ–‡ä»¶
â”‚ â”œâ”€â”€ build.sc # ç”¨äºé…ç½®Millç¼–è¯‘å·¥å…·
â”‚ â”œâ”€â”€ out # ç”¨äºå­˜å‚¨millç¼–è¯‘åçš„æ–‡ä»¶
â”‚ â”œâ”€â”€ playground
â”‚ â”‚ â”œâ”€â”€ resources # ç”¨äºå­˜å‚¨CPUè®¾è®¡ç›¸å…³çš„Verilogæ–‡ä»¶
â”‚ â”‚ â”œâ”€â”€ src # ç”¨äºå­˜å‚¨CPUè®¾è®¡ç›¸å…³çš„Chiselæ–‡ä»¶
â”‚ â”‚ â””â”€â”€ test # ç”¨äºå­˜å‚¨CPUè®¾è®¡ç›¸å…³çš„Chiselæµ‹è¯•æ–‡ä»¶
â”‚ â””â”€â”€ utils # ç”¨äºå­˜å‚¨firtoolç›¸å…³çš„æ–‡ä»¶
â”œâ”€â”€ difftest # å·®åˆ†æµ‹è¯•æ¡†æ¶
```

## ğŸ› ï¸ ç¯å¢ƒé…ç½®

- ä»¥ä¸‹é…ç½®æµç¨‹åœ¨ Ubuntu22.04 ä»¥åŠ WSL2 çš„ Ubuntu22.04 ç‰ˆæœ¬ä¸‹å¾—åˆ°éªŒè¯ï¼Œå¯é¡ºåˆ©æ‰§è¡Œ
- å¯¹äº Mac ç”¨æˆ·ï¼Œå¯ä½¿ç”¨ brew å·¥å…·ç›´æ¥å®‰è£…å¯¹åº”çš„å·¥å…·ï¼ˆç”±äº brew å®‰è£…çš„ Mill çš„ç‰ˆæœ¬è¾ƒæ–°ï¼Œéœ€å°† chisel/build.sc çš„å†…å®¹æ›¿æ¢ä¸º [chisel-playground/build.mill](https://github.com/OSCPU/chisel-playground/blob/master/build.mill) ä¸­çš„å†…å®¹ä»¥è§£å†³ç¯å¢ƒæ„å»ºé—®é¢˜ï¼‰
- æ¨èä½¿ç”¨ Ubuntu22.04 ç‰ˆæœ¬è¿›è¡Œå®éªŒï¼Œå¯¹äºå…¶ä»–ç¯å¢ƒå‡ºç°çš„é—®é¢˜è¯·å…ˆè‡ªå·±å°è¯•è§£å†³

### ğŸ• å®‰è£… Verilator

```bash
sudo apt-get install git help2man perl python3 make autoconf g++ flex bison ccache
sudo apt-get install libgoogle-perftools-dev numactl perl-doc
sudo apt-get install libfl2 # å¦‚æœæŠ¥é”™å¿½ç•¥å³å¯
sudo apt-get install libfl-dev # å¦‚æœæŠ¥é”™å¿½ç•¥å³å¯
sudo apt-get install zlibc zlib1g zlib1g-dev # å¦‚æœæŠ¥é”™å¿½ç•¥å³å¯

cd ~
git clone https://github.com/verilator/verilator # æ‹‰å– verilator çš„ä»“åº“ï¼Œæ‰§è¡Œè¿‡ä¸€æ¬¡å³å¯

unset VERILATOR_ROOT
cd verilator
git checkout v5.010 # æ¨èå®‰è£…ä½¿ç”¨ 5.010 ç‰ˆæœ¬
autoconf
./configure
make -j `nproc` # å¦‚æœæŠ¥é”™è¯·å°è¯•ç›´æ¥è¾“å…¥ make å‘½ä»¤
sudo make install

# ç»è¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œverilatoråº”è¯¥å·²ç»å®‰è£…å®Œæ¯•ï¼Œå¯ä»¥åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸï¼š
verilator â€“-version
# å¦‚æœæ­£ç¡®çš„è¾“å‡ºäº†ç‰ˆæœ¬å·ï¼Œåˆ™è¯´æ˜å®‰è£…æˆåŠŸï¼›å¦‚æœæŠ¥é”™ï¼Œå¯ä»¥å°è¯•é‡æ–°å®‰è£…ã€‚
```

### ğŸ” å®‰è£… GTKWave

```bash
sudo apt-get install gtkwave

# ä½¿ç”¨æ–¹æ³•ä¸º
gtkwave <æ³¢å½¢æ–‡ä»¶çš„è·¯å¾„>
```

### ğŸŸ å®‰è£… Java

```bash
sudo apt-get install openjdk-11-jdk
java --version # è‹¥å®‰è£…æˆåŠŸå°†è¾“å‡ºå¯¹åº”ç‰ˆæœ¬å·
```

### ğŸŒ­ å®‰è£… Mill

```bash
curl -L https://github.com/com-lihaoyi/mill/releases/download/0.11.6/0.11.6 > mill && chmod +x mill
mv mill /usr/bin/mill
mill --version # è‹¥å®‰è£…æˆåŠŸå°†è¾“å‡ºå¯¹åº”ç‰ˆæœ¬å·
```

### ğŸ– å®‰è£… VS Code

- å®‰è£… VS Code
- å®‰è£… Scalaï¼ˆMetalsï¼‰æ’ä»¶
- å®‰è£… Todo Tree æ’ä»¶
- å®‰è£… Git Graph æ’ä»¶

### ğŸ¥“ å®‰è£…å®éªŒæ¡†æ¶

```bash
git clone https://bdgit.educoder.net/ppg69fuwb/riscv-lab.git
cd riscv-lab

git config --global user.name "244050090-Zhang San" # è®¾ç½®å­¦å·å’Œå§“å
git config --global user.email "zhangsan@foo.com"   # è®¾ç½®é‚®ç®±
git config --global core.editor vim                 # è®¾ç½®æ–‡æœ¬ç¼–è¾‘å™¨
git config --global color.ui true

bash init.sh difftest
source ~/.bashrc
echo $RVDIFF_HOME # æŸ¥çœ‹æ˜¯å¦æˆåŠŸè¾“å‡º difftest æ–‡ä»¶å¤¹çš„è·¯å¾„ï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼
```

### ğŸ¥™ ç¯å¢ƒå®Œæ•´æ€§æµ‹è¯•

```bash
cd difftest
git checkout env_test # åˆ‡æ¢åˆ° env_test åˆ†æ”¯
make envtest # æµ‹è¯•ç¯å¢ƒå®Œæ•´æ€§
```

è§‚å¯Ÿ chisel/build ç›®å½•ä¸‹æ˜¯å¦æˆåŠŸç”Ÿæˆ GCD.sv æ–‡ä»¶ï¼Œè‹¥æˆåŠŸåˆ™è¯´æ˜ Chisel ç¯å¢ƒé…ç½®æˆåŠŸ

è§‚å¯Ÿå‘½ä»¤è¡Œæ˜¯å¦å­˜åœ¨ä»¥ä¸‹è¾“å‡ºï¼š

```bash
Error!
reference: PC = 0x0000000080000010, wb_rf_wnum = 0x02, wb_rf_wdata = 0x0000000000000001
mycpu    : PC = 0x0000000080000010, wb_rf_wnum = 0x02, wb_rf_wdata = 0x0000000000000000
```

è‹¥å­˜åœ¨ç±»ä¼¼è¾“å‡ºåˆ™è¯´æ˜å·®åˆ†æµ‹è¯•ç¯å¢ƒé…ç½®æˆåŠŸ

## ğŸ›¸ å¼€å§‹å®éªŒ

```bash
git checkout main # åˆ‡æ¢åˆ° main åˆ†æ”¯ï¼Œå®éªŒä»£ç å‡åœ¨ main åˆ†æ”¯ä¸‹
git pull # æ‹‰å–æœ€æ–°ä»£ç 
```

å»ºè®®ä½¿ç”¨ Vs Code å°† Chisel ç›®å½•ä½œä¸ºå·¥ä½œç›®å½•ï¼Œå¯ä»¥é€šè¿‡ `code <æ–‡ä»¶è·¯å¾„>` å‘½ä»¤ä½¿ç”¨ Vs Code æ‰“å¼€å¯¹åº”æ–‡ä»¶

æ‰€æœ‰çš„ make æŒ‡ä»¤å‡åœ¨ difftest ç›®å½•ä¸‹æ‰§è¡Œï¼Œå¦‚ `make verilog`ï¼Œ`make lab1`ï¼Œ`make trace_lab1` ç­‰

éƒ¨åˆ†å®éªŒå­˜åœ¨å¤šä¸ªæµ‹ä¾‹ï¼Œæ­¤æ—¶ trace.fst æ–‡ä»¶éœ€æ‰‹åŠ¨ç”Ÿæˆï¼Œåœ¨ difftest ç›®å½•ä¸‹ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨ç”Ÿæˆ CPU æ³¢å½¢æ–‡ä»¶

```bash
make trace TESTBIN_DIR=<æµ‹ä¾‹å¯¹åº”çš„binæ–‡ä»¶çš„è·¯å¾„>

# å¦‚åœ¨ difftest ç›®å½•ä¸‹è¾“å…¥ä»¥ä¸‹å‘½ä»¤å¯ç”ŸæˆCPUè¿è¡Œ am-tests/01-add-longlong.bin æµ‹ä¾‹çš„æ³¢å½¢
make trace TESTBIN_DIR=./test/bin/am-tests/01-add-longlong.bin
```

## ğŸ“¢ æ³¨æ„äº‹é¡¹

- ç¼–ç¨‹ä½ç½®ä½äº chisel ä¸­
- æµ‹è¯•ä½ç½®ä½äº difftest ä¸­
- è¿›å…¥ difftest ç›®å½•å
  - ä½¿ç”¨ `make verilog` ç”Ÿæˆ verilog ä»£ç ï¼ˆé¦–æ¬¡å®éªŒéœ€è¦æŒ‰å®éªŒè¦æ±‚è¡¥å……ä»£ç ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰
  - ä½¿ç”¨ `make lab1` è¿›è¡Œ å®éªŒ 1 çš„æµ‹è¯•
  - ä½¿ç”¨ `make trace_lab1` è¿›è¡Œ å®éªŒ 1 çš„ CPU æµ‹è¯•è®°å½•ç”Ÿæˆ
  - å®éªŒ 2 ä¸º lab2ï¼Œä»¥æ­¤ç±»æ¨
  - difftest ç›®å½•ä¸‹çš„ trace.txt æ–‡ä»¶ä¸ºæµ‹è¯•ç»“æœï¼Œç”¨äºæäº¤å¤´æ­Œå¹³å°ï¼Œä½œä¸ºè¯„åˆ†ä¾æ®
- åœ¨å®éªŒæ—¶åŠ¡å¿…ç¡®è®¤ git ä¸‹æœ‰äº§ç”Ÿå®éªŒè®°å½•ï¼Œè¿™æ˜¯é‡è¦çš„é‡‡åˆ†ç‚¹ä¹‹ä¸€ï¼Œå¯é€šè¿‡ `git log tracer-rvlab` æŸ¥çœ‹ï¼ˆå¦‚æœæ²¡æœ‰äº§ç”Ÿå®éªŒè®°å½•ï¼Œè¯·æ£€æŸ¥ RVDIFF_HOME æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼‰

## ğŸ“¦ èµ„æº

- ğŸ§°[RISC-V Convertor](https://luplab.gitlab.io/rvcodecjs/) - RISC-V æ±‡ç¼–è½¬æ¢å™¨
- ğŸ“‘[Chisel Project Template](https://github.com/OSCPU/chisel-playground) - Chisel é¡¹ç›®æ¨¡æ¿
